# =============================================================================
# Source: exec + snmpget
# Runs snmpget every 1 second against the local snmpd (localhost:161).
# Each OID is fetched in a single command; stdout is parsed as a Fluentd event.
# =============================================================================
<source>
  @type exec
  tag snmp.resource

  # snmpget -v2c        : SNMP version 2c
  # -c public           : community string (must match snmpd.conf rocommunity)
  # -Oqv               : output value only, no OID prefix, no unit suffix
  # localhost           : SNMP Agent = Pi's own snmpd
  # OIDs correspond to: TX bytes, RX bytes, TX drops, RX drops,
  #                     TX errors, RX errors, CPU load, free RAM, disk util
  command bash -c 'echo "{\"tx_bytes\":$(snmpget -v2c -c public -Oqv localhost 1.3.6.1.2.1.2.2.1.16.2),\"rx_bytes\":$(snmpget -v2c -c public -Oqv localhost 1.3.6.1.2.1.2.2.1.10.2),\"tx_drops\":$(snmpget -v2c -c public -Oqv localhost 1.3.6.1.2.1.2.2.1.19.2),\"rx_drops\":$(snmpget -v2c -c public -Oqv localhost 1.3.6.1.2.1.2.2.1.13.2),\"tx_errors\":$(snmpget -v2c -c public -Oqv localhost 1.3.6.1.2.1.2.2.1.20.2),\"rx_errors\":$(snmpget -v2c -c public -Oqv localhost 1.3.6.1.2.1.2.2.1.14.2),\"cpu_load\":$(snmpget -v2c -c public -Oqv localhost 1.3.6.1.4.1.2021.10.1.3.1),\"free_ram\":$(snmpget -v2c -c public -Oqv localhost 1.3.6.1.4.1.2021.4.6.0),\"disk_util\":$(snmpget -v2c -c public -Oqv localhost 1.3.6.1.4.1.2021.9.1.9.1)}"'

  run_interval 1s

  <parse>
    @type json
  </parse>
</source>

# =============================================================================
# Match: send all snmp.* events to Kafka
# Replace 'nuc' with the NUC hostname defined in /etc/hosts if different.
# =============================================================================
<match snmp.**>
  @type kafka2

  # Kafka 4.x KRaft brokers (no ZooKeeper)
  brokers <YOUR_NUC_HOSTNAME>:9090,<YOUR_NUC_HOSTNAME>:9091,<YOUR_NUC_HOSTNAME>:9092

  default_topic resource

  <format>
    @type json
  </format>

  # rdkafka2 backend â€” required for Kafka 4.x compatibility
  <inject>
    time_key time
    time_type string
    time_format %Y-%m-%dT%H:%M:%S%z
  </inject>
</match>
